/*
 * Copyright 2019-2021 NXP
 *
 * SPDX-License-Identifier: BSD-3-Clause
 */
#include <common/debug.h>
#include <ddr/ddr_utils.h>
#include <ddr/ddr_utils.h>
#include <lib/utils_def.h>
#include <nxp/s32g/ddr/ddrss.h>
#include <platform.h>
#include <s32g_mc_rgm.h>
#include <ssram_mailbox.h>
#include <stdbool.h>

#define OFFSET_DDRC_PSTAT		0x4
#define SCRUB_EN_MASK			BIT(0)
#define SCRUB_BUSY_MASK			BIT(0)
#define OFFSET_DDRC_INIT0		0xd0
#define SELFREF_SW_MASK			BIT(5)
#define SELFREF_TYPE_MASK		(BIT(4) | BIT(5))
#define OPERATING_MODE_MASK		(BIT(0) | BIT(1) | BIT(2))
#define DFI_INIT_COMPLETE_MASK		BIT(0)
#define DFI_INIT_START_MASK		BIT(5)
#define DDRSS_BASE_ADDR			0x40380000
#define DDR_SUBSYSTEM			(DDRSS_BASE_ADDR + 0x50000)
#define DWC_DDRPHYA_APBONLY0		(DDRSS_BASE_ADDR + 0x400)
#define MICROCONTMUXSEL			(DWC_DDRPHYA_APBONLY0 + 0x0)
#define MICROCONTMUXSEL_MASK		BIT(0)
#define SW_DONE_ACK_MASK		BIT(0)
#define SW_DONE_MASK			BIT(0)
#define SKIP_DRAM_INIT_MASK		(BIT(30) | BIT(31))
#define DWC_DDRPHYA_DRTUB0		(DDRSS_BASE_ADDR + 0xbd0)
#define UCCLKHCLKENABLES		(DWC_DDRPHYA_DRTUB0 + 0x1c)
#define UCCLKEN_MASK			BIT(0)
#define HCLKEN_MASK			BIT(1)
#define DDR_GPR				(0x4007c600ul)
#define DDR_CONFIG_0			(DDR_GPR + 0x00)
#define DDR_RET_CONTROL			(DDR_GPR + 0x1c)
#define DDR_RET_CONTROL_MASK		BIT(0)
#define DDR_CONFIG_0_MEM_RET		BIT(14)
#define DFI_FREQUENCY(f)		((f) << 8)
#define SELFREF_STATE_SRPD		(0x2 << 8)
#define SELFREF_STATE_MASK		(BIT(8) | BIT(9))
#define SELFREF_TYPE_NOT_UNDER_AUTO_SR_CTRL	(0x2 << 4)
#define OPERATING_MODE_SELF_REFRESH	(0x3)

static const uint32_t csr_to_store[] = {
	0x00001690,	/* DWC_DDRPHYA_MASTER0_VREFINGLOBAL_P0 */
	0x00001718,	/* DWC_DDRPHYA_MASTER0_PLLCTRL3 */
	0x0001451c,	/* DWC_DDRPHYA_DBYTE0_DQDQSRCVCNTRL_B0_P0 */
	0x0001651c,	/* DWC_DDRPHYA_DBYTE1_DQDQSRCVCNTRL_B0_P0 */
	0x0001851c,	/* DWC_DDRPHYA_DBYTE2_DQDQSRCVCNTRL_B0_P0 */
	0x0001a51c,	/* DWC_DDRPHYA_DBYTE3_DQDQSRCVCNTRL_B0_P0 */
	0x00014520,	/* DWC_DDRPHYA_DBYTE0_DQDQSRCVCNTRL_B1_P0 */
	0x00016520,	/* DWC_DDRPHYA_DBYTE1_DQDQSRCVCNTRL_B1_P0 */
	0x00018520,	/* DWC_DDRPHYA_DBYTE2_DQDQSRCVCNTRL_B1_P0 */
	0x0001a520,	/* DWC_DDRPHYA_DBYTE3_DQDQSRCVCNTRL_B1_P0 */
	0x000003f0,	/* DWC_DDRPHYA_ANIB0_ATXDLY_P0 */
	0x000023f0,	/* DWC_DDRPHYA_ANIB1_ATXDLY_P0 */
	0x000043f0,	/* DWC_DDRPHYA_ANIB2_ATXDLY_P0 */
	0x000063f0,	/* DWC_DDRPHYA_ANIB3_ATXDLY_P0 */
	0x000146b0,	/* DWC_DDRPHYA_DBYTE0_RXENDLYTG0_U0_P0 */
	0x000166b0,	/* DWC_DDRPHYA_DBYTE1_RXENDLYTG0_U0_P0 */
	0x000186b0,	/* DWC_DDRPHYA_DBYTE2_RXENDLYTG0_U0_P0 */
	0x0001a6b0,	/* DWC_DDRPHYA_DBYTE3_RXENDLYTG0_U0_P0 */
	0x000146b4,	/* DWC_DDRPHYA_DBYTE0_RXENDLYTG0_U1_P0 */
	0x000166b4,	/* DWC_DDRPHYA_DBYTE1_RXENDLYTG0_U1_P0 */
	0x000186b4,	/* DWC_DDRPHYA_DBYTE2_RXENDLYTG0_U1_P0 */
	0x0001a6b4,	/* DWC_DDRPHYA_DBYTE3_RXENDLYTG0_U1_P0 */
	0x000146d0,	/* DWC_DDRPHYA_DBYTE0_RXENDLYTG1_U0_P0 */
	0x000166d0,	/* DWC_DDRPHYA_DBYTE1_RXENDLYTG1_U0_P0 */
	0x000186d0,	/* DWC_DDRPHYA_DBYTE2_RXENDLYTG1_U0_P0 */
	0x0001a6d0,	/* DWC_DDRPHYA_DBYTE3_RXENDLYTG1_U0_P0 */
	0x000146d4,	/* DWC_DDRPHYA_DBYTE0_RXENDLYTG1_U1_P0 */
	0x000166d4,	/* DWC_DDRPHYA_DBYTE1_RXENDLYTG1_U1_P0 */
	0x000186d4,	/* DWC_DDRPHYA_DBYTE2_RXENDLYTG1_U1_P0 */
	0x0001a6d4,	/* DWC_DDRPHYA_DBYTE3_RXENDLYTG1_U1_P0 */
	0x00014b50,	/* DWC_DDRPHYA_DBYTE0_TXDQSDLYTG0_U1_P0 */
	0x00016b50,	/* DWC_DDRPHYA_DBYTE1_TXDQSDLYTG0_U1_P0 */
	0x00018b50,	/* DWC_DDRPHYA_DBYTE2_TXDQSDLYTG0_U1_P0 */
	0x0001ab50,	/* DWC_DDRPHYA_DBYTE3_TXDQSDLYTG0_U1_P0 */
	0x00014b4c,	/* DWC_DDRPHYA_DBYTE0_TXDQSDLYTG0_U0_P0 */
	0x00016b4c,	/* DWC_DDRPHYA_DBYTE1_TXDQSDLYTG0_U0_P0 */
	0x00018b4c,	/* DWC_DDRPHYA_DBYTE2_TXDQSDLYTG0_U0_P0 */
	0x0001ab4c,	/* DWC_DDRPHYA_DBYTE3_TXDQSDLYTG0_U0_P0 */
	0x00014b70,	/* DWC_DDRPHYA_DBYTE0_TXDQSDLYTG1_U1_P0 */
	0x00016b70,	/* DWC_DDRPHYA_DBYTE1_TXDQSDLYTG1_U1_P0 */
	0x00018b70,	/* DWC_DDRPHYA_DBYTE2_TXDQSDLYTG1_U1_P0 */
	0x0001ab70,	/* DWC_DDRPHYA_DBYTE3_TXDQSDLYTG1_U1_P0 */
	0x00014b6c,	/* DWC_DDRPHYA_DBYTE0_TXDQSDLYTG1_U0_P0 */
	0x00016b6c,	/* DWC_DDRPHYA_DBYTE1_TXDQSDLYTG1_U0_P0 */
	0x00018b6c,	/* DWC_DDRPHYA_DBYTE2_TXDQSDLYTG1_U0_P0 */
	0x0001ab6c,	/* DWC_DDRPHYA_DBYTE3_TXDQSDLYTG1_U0_P0 */
	0x00014640,	/* DWC_DDRPHYA_DBYTE0_RXPBDLYTG0_R8 */
	0x00016640,	/* DWC_DDRPHYA_DBYTE1_RXPBDLYTG0_R8 */
	0x00018640,	/* DWC_DDRPHYA_DBYTE2_RXPBDLYTG0_R8 */
	0x0001a640,	/* DWC_DDRPHYA_DBYTE3_RXPBDLYTG0_R8 */
	0x0001463c,	/* DWC_DDRPHYA_DBYTE0_RXPBDLYTG0_R7 */
	0x0001663c,	/* DWC_DDRPHYA_DBYTE1_RXPBDLYTG0_R7 */
	0x0001863c,	/* DWC_DDRPHYA_DBYTE2_RXPBDLYTG0_R7 */
	0x0001a63c,	/* DWC_DDRPHYA_DBYTE3_RXPBDLYTG0_R7 */
	0x00014638,	/* DWC_DDRPHYA_DBYTE0_RXPBDLYTG0_R6 */
	0x00016638,	/* DWC_DDRPHYA_DBYTE1_RXPBDLYTG0_R6 */
	0x00018638,	/* DWC_DDRPHYA_DBYTE2_RXPBDLYTG0_R6 */
	0x0001a638,	/* DWC_DDRPHYA_DBYTE3_RXPBDLYTG0_R6 */
	0x00014634,	/* DWC_DDRPHYA_DBYTE0_RXPBDLYTG0_R5 */
	0x00016634,	/* DWC_DDRPHYA_DBYTE1_RXPBDLYTG0_R5 */
	0x00018634,	/* DWC_DDRPHYA_DBYTE2_RXPBDLYTG0_R5 */
	0x0001a634,	/* DWC_DDRPHYA_DBYTE3_RXPBDLYTG0_R5 */
	0x00014630,	/* DWC_DDRPHYA_DBYTE0_RXPBDLYTG0_R4 */
	0x00016630,	/* DWC_DDRPHYA_DBYTE1_RXPBDLYTG0_R4 */
	0x00018630,	/* DWC_DDRPHYA_DBYTE2_RXPBDLYTG0_R4 */
	0x0001a630,	/* DWC_DDRPHYA_DBYTE3_RXPBDLYTG0_R4 */
	0x0001462c,	/* DWC_DDRPHYA_DBYTE0_RXPBDLYTG0_R3 */
	0x0001662c,	/* DWC_DDRPHYA_DBYTE1_RXPBDLYTG0_R3 */
	0x0001862c,	/* DWC_DDRPHYA_DBYTE2_RXPBDLYTG0_R3 */
	0x0001a62c,	/* DWC_DDRPHYA_DBYTE3_RXPBDLYTG0_R3 */
	0x00014628,	/* DWC_DDRPHYA_DBYTE0_RXPBDLYTG0_R2 */
	0x00016628,	/* DWC_DDRPHYA_DBYTE1_RXPBDLYTG0_R2 */
	0x00018628,	/* DWC_DDRPHYA_DBYTE2_RXPBDLYTG0_R2 */
	0x0001a628,	/* DWC_DDRPHYA_DBYTE3_RXPBDLYTG0_R2 */
	0x00014624,	/* DWC_DDRPHYA_DBYTE0_RXPBDLYTG0_R1 */
	0x00016624,	/* DWC_DDRPHYA_DBYTE1_RXPBDLYTG0_R1 */
	0x00018624,	/* DWC_DDRPHYA_DBYTE2_RXPBDLYTG0_R1 */
	0x0001a624,	/* DWC_DDRPHYA_DBYTE3_RXPBDLYTG0_R1 */
	0x00014620,	/* DWC_DDRPHYA_DBYTE0_RXPBDLYTG0_R0 */
	0x00016620,	/* DWC_DDRPHYA_DBYTE1_RXPBDLYTG0_R0 */
	0x00018620,	/* DWC_DDRPHYA_DBYTE2_RXPBDLYTG0_R0 */
	0x0001a620,	/* DWC_DDRPHYA_DBYTE3_RXPBDLYTG0_R0 */
	0x00014664,	/* DWC_DDRPHYA_DBYTE0_RXPBDLYTG1_R8 */
	0x00016664,	/* DWC_DDRPHYA_DBYTE1_RXPBDLYTG1_R8 */
	0x00018664,	/* DWC_DDRPHYA_DBYTE2_RXPBDLYTG1_R8 */
	0x0001a664,	/* DWC_DDRPHYA_DBYTE3_RXPBDLYTG1_R8 */
	0x00014660,	/* DWC_DDRPHYA_DBYTE0_RXPBDLYTG1_R7 */
	0x00016660,	/* DWC_DDRPHYA_DBYTE1_RXPBDLYTG1_R7 */
	0x00018660,	/* DWC_DDRPHYA_DBYTE2_RXPBDLYTG1_R7 */
	0x0001a660,	/* DWC_DDRPHYA_DBYTE3_RXPBDLYTG1_R7 */
	0x0001465c,	/* DWC_DDRPHYA_DBYTE0_RXPBDLYTG1_R6 */
	0x0001665c,	/* DWC_DDRPHYA_DBYTE1_RXPBDLYTG1_R6 */
	0x0001865c,	/* DWC_DDRPHYA_DBYTE2_RXPBDLYTG1_R6 */
	0x0001a65c,	/* DWC_DDRPHYA_DBYTE3_RXPBDLYTG1_R6 */
	0x00014658,	/* DWC_DDRPHYA_DBYTE0_RXPBDLYTG1_R5 */
	0x00016658,	/* DWC_DDRPHYA_DBYTE1_RXPBDLYTG1_R5 */
	0x00018658,	/* DWC_DDRPHYA_DBYTE2_RXPBDLYTG1_R5 */
	0x0001a658,	/* DWC_DDRPHYA_DBYTE3_RXPBDLYTG1_R5 */
	0x00014654,	/* DWC_DDRPHYA_DBYTE0_RXPBDLYTG1_R4 */
	0x00016654,	/* DWC_DDRPHYA_DBYTE1_RXPBDLYTG1_R4 */
	0x00018654,	/* DWC_DDRPHYA_DBYTE2_RXPBDLYTG1_R4 */
	0x0001a654,	/* DWC_DDRPHYA_DBYTE3_RXPBDLYTG1_R4 */
	0x00014650,	/* DWC_DDRPHYA_DBYTE0_RXPBDLYTG1_R3 */
	0x00016650,	/* DWC_DDRPHYA_DBYTE1_RXPBDLYTG1_R3 */
	0x00018650,	/* DWC_DDRPHYA_DBYTE2_RXPBDLYTG1_R3 */
	0x0001a650,	/* DWC_DDRPHYA_DBYTE3_RXPBDLYTG1_R3 */
	0x0001464c,	/* DWC_DDRPHYA_DBYTE0_RXPBDLYTG1_R2 */
	0x0001664c,	/* DWC_DDRPHYA_DBYTE1_RXPBDLYTG1_R2 */
	0x0001864c,	/* DWC_DDRPHYA_DBYTE2_RXPBDLYTG1_R2 */
	0x0001a64c,	/* DWC_DDRPHYA_DBYTE3_RXPBDLYTG1_R2 */
	0x00014648,	/* DWC_DDRPHYA_DBYTE0_RXPBDLYTG1_R1 */
	0x00016648,	/* DWC_DDRPHYA_DBYTE1_RXPBDLYTG1_R1 */
	0x00018648,	/* DWC_DDRPHYA_DBYTE2_RXPBDLYTG1_R1 */
	0x0001a648,	/* DWC_DDRPHYA_DBYTE3_RXPBDLYTG1_R1 */
	0x00014644,	/* DWC_DDRPHYA_DBYTE0_RXPBDLYTG1_R0 */
	0x00016644,	/* DWC_DDRPHYA_DBYTE1_RXPBDLYTG1_R0 */
	0x00018644,	/* DWC_DDRPHYA_DBYTE2_RXPBDLYTG1_R0 */
	0x0001a644,	/* DWC_DDRPHYA_DBYTE3_RXPBDLYTG1_R0 */
	0x00014730,	/* DWC_DDRPHYA_DBYTE0_RXCLKDLYTG0_U0_P0 */
	0x00016730,	/* DWC_DDRPHYA_DBYTE1_RXCLKDLYTG0_U0_P0 */
	0x00018730,	/* DWC_DDRPHYA_DBYTE2_RXCLKDLYTG0_U0_P0 */
	0x0001a730,	/* DWC_DDRPHYA_DBYTE3_RXCLKDLYTG0_U0_P0 */
	0x00014734,	/* DWC_DDRPHYA_DBYTE0_RXCLKDLYTG0_U1_P0 */
	0x00016734,	/* DWC_DDRPHYA_DBYTE1_RXCLKDLYTG0_U1_P0 */
	0x00018734,	/* DWC_DDRPHYA_DBYTE2_RXCLKDLYTG0_U1_P0 */
	0x0001a734,	/* DWC_DDRPHYA_DBYTE3_RXCLKDLYTG0_U1_P0 */
	0x00014750,	/* DWC_DDRPHYA_DBYTE0_RXCLKDLYTG1_U0_P0 */
	0x00016750,	/* DWC_DDRPHYA_DBYTE1_RXCLKDLYTG1_U0_P0 */
	0x00018750,	/* DWC_DDRPHYA_DBYTE2_RXCLKDLYTG1_U0_P0 */
	0x0001a750,	/* DWC_DDRPHYA_DBYTE3_RXCLKDLYTG1_U0_P0 */
	0x00014754,	/* DWC_DDRPHYA_DBYTE0_RXCLKDLYTG1_U1_P0 */
	0x00016754,	/* DWC_DDRPHYA_DBYTE1_RXCLKDLYTG1_U1_P0 */
	0x00018754,	/* DWC_DDRPHYA_DBYTE2_RXCLKDLYTG1_U1_P0 */
	0x0001a754,	/* DWC_DDRPHYA_DBYTE3_RXCLKDLYTG1_U1_P0 */
	0x0001492c,	/* DWC_DDRPHYA_DBYTE0_TXDQDLYTG0_R8_P0 */
	0x0001692c,	/* DWC_DDRPHYA_DBYTE1_TXDQDLYTG0_R8_P0 */
	0x0001892c,	/* DWC_DDRPHYA_DBYTE2_TXDQDLYTG0_R8_P0 */
	0x0001a92c,	/* DWC_DDRPHYA_DBYTE3_TXDQDLYTG0_R8_P0 */
	0x00014928,	/* DWC_DDRPHYA_DBYTE0_TXDQDLYTG0_R7_P0 */
	0x00016928,	/* DWC_DDRPHYA_DBYTE1_TXDQDLYTG0_R7_P0 */
	0x00018928,	/* DWC_DDRPHYA_DBYTE2_TXDQDLYTG0_R7_P0 */
	0x0001a928,	/* DWC_DDRPHYA_DBYTE3_TXDQDLYTG0_R7_P0 */
	0x00014924,	/* DWC_DDRPHYA_DBYTE0_TXDQDLYTG0_R6_P0 */
	0x00016924,	/* DWC_DDRPHYA_DBYTE1_TXDQDLYTG0_R6_P0 */
	0x00018924,	/* DWC_DDRPHYA_DBYTE2_TXDQDLYTG0_R6_P0 */
	0x0001a924,	/* DWC_DDRPHYA_DBYTE3_TXDQDLYTG0_R6_P0 */
	0x00014920,	/* DWC_DDRPHYA_DBYTE0_TXDQDLYTG0_R5_P0 */
	0x00016920,	/* DWC_DDRPHYA_DBYTE1_TXDQDLYTG0_R5_P0 */
	0x00018920,	/* DWC_DDRPHYA_DBYTE2_TXDQDLYTG0_R5_P0 */
	0x0001a920,	/* DWC_DDRPHYA_DBYTE3_TXDQDLYTG0_R5_P0 */
	0x0001491c,	/* DWC_DDRPHYA_DBYTE0_TXDQDLYTG0_R4_P0 */
	0x0001691c,	/* DWC_DDRPHYA_DBYTE1_TXDQDLYTG0_R4_P0 */
	0x0001891c,	/* DWC_DDRPHYA_DBYTE2_TXDQDLYTG0_R4_P0 */
	0x0001a91c,	/* DWC_DDRPHYA_DBYTE3_TXDQDLYTG0_R4_P0 */
	0x00014918,	/* DWC_DDRPHYA_DBYTE0_TXDQDLYTG0_R3_P0 */
	0x00016918,	/* DWC_DDRPHYA_DBYTE1_TXDQDLYTG0_R3_P0 */
	0x00018918,	/* DWC_DDRPHYA_DBYTE2_TXDQDLYTG0_R3_P0 */
	0x0001a918,	/* DWC_DDRPHYA_DBYTE3_TXDQDLYTG0_R3_P0 */
	0x00014914,	/* DWC_DDRPHYA_DBYTE0_TXDQDLYTG0_R2_P0 */
	0x00016914,	/* DWC_DDRPHYA_DBYTE1_TXDQDLYTG0_R2_P0 */
	0x00018914,	/* DWC_DDRPHYA_DBYTE2_TXDQDLYTG0_R2_P0 */
	0x0001a914,	/* DWC_DDRPHYA_DBYTE3_TXDQDLYTG0_R2_P0 */
	0x00014910,	/* DWC_DDRPHYA_DBYTE0_TXDQDLYTG0_R1_P0 */
	0x00016910,	/* DWC_DDRPHYA_DBYTE1_TXDQDLYTG0_R1_P0 */
	0x00018910,	/* DWC_DDRPHYA_DBYTE2_TXDQDLYTG0_R1_P0 */
	0x0001a910,	/* DWC_DDRPHYA_DBYTE3_TXDQDLYTG0_R1_P0 */
	0x0001490c,	/* DWC_DDRPHYA_DBYTE0_TXDQDLYTG0_R0_P0 */
	0x0001690c,	/* DWC_DDRPHYA_DBYTE1_TXDQDLYTG0_R0_P0 */
	0x0001890c,	/* DWC_DDRPHYA_DBYTE2_TXDQDLYTG0_R0_P0 */
	0x0001a90c,	/* DWC_DDRPHYA_DBYTE3_TXDQDLYTG0_R0_P0 */
	0x000149bc,	/* DWC_DDRPHYA_DBYTE0_TXDQDLYTG1_R8_P0 */
	0x000169bc,	/* DWC_DDRPHYA_DBYTE1_TXDQDLYTG1_R8_P0 */
	0x000189bc,	/* DWC_DDRPHYA_DBYTE2_TXDQDLYTG1_R8_P0 */
	0x0001a9bc,	/* DWC_DDRPHYA_DBYTE3_TXDQDLYTG1_R8_P0 */
	0x000149b8,	/* DWC_DDRPHYA_DBYTE0_TXDQDLYTG1_R7_P0 */
	0x000169b8,	/* DWC_DDRPHYA_DBYTE1_TXDQDLYTG1_R7_P0 */
	0x000189b8,	/* DWC_DDRPHYA_DBYTE2_TXDQDLYTG1_R7_P0 */
	0x0001a9b8,	/* DWC_DDRPHYA_DBYTE3_TXDQDLYTG1_R7_P0 */
	0x000149b4,	/* DWC_DDRPHYA_DBYTE0_TXDQDLYTG1_R6_P0 */
	0x000169b4,	/* DWC_DDRPHYA_DBYTE1_TXDQDLYTG1_R6_P0 */
	0x000189b4,	/* DWC_DDRPHYA_DBYTE2_TXDQDLYTG1_R6_P0 */
	0x0001a9b4,	/* DWC_DDRPHYA_DBYTE3_TXDQDLYTG1_R6_P0 */
	0x000149b0,	/* DWC_DDRPHYA_DBYTE0_TXDQDLYTG1_R5_P0 */
	0x000169b0,	/* DWC_DDRPHYA_DBYTE1_TXDQDLYTG1_R5_P0 */
	0x000189b0,	/* DWC_DDRPHYA_DBYTE2_TXDQDLYTG1_R5_P0 */
	0x0001a9b0,	/* DWC_DDRPHYA_DBYTE3_TXDQDLYTG1_R5_P0 */
	0x000149ac,	/* DWC_DDRPHYA_DBYTE0_TXDQDLYTG1_R4_P0 */
	0x000169ac,	/* DWC_DDRPHYA_DBYTE1_TXDQDLYTG1_R4_P0 */
	0x000189ac,	/* DWC_DDRPHYA_DBYTE2_TXDQDLYTG1_R4_P0 */
	0x0001a9ac,	/* DWC_DDRPHYA_DBYTE3_TXDQDLYTG1_R4_P0 */
	0x000149a8,	/* DWC_DDRPHYA_DBYTE0_TXDQDLYTG1_R3_P0 */
	0x000169a8,	/* DWC_DDRPHYA_DBYTE1_TXDQDLYTG1_R3_P0 */
	0x000189a8,	/* DWC_DDRPHYA_DBYTE2_TXDQDLYTG1_R3_P0 */
	0x0001a9a8,	/* DWC_DDRPHYA_DBYTE3_TXDQDLYTG1_R3_P0 */
	0x000149a4,	/* DWC_DDRPHYA_DBYTE0_TXDQDLYTG1_R2_P0 */
	0x000169a4,	/* DWC_DDRPHYA_DBYTE1_TXDQDLYTG1_R2_P0 */
	0x000189a4,	/* DWC_DDRPHYA_DBYTE2_TXDQDLYTG1_R2_P0 */
	0x0001a9a4,	/* DWC_DDRPHYA_DBYTE3_TXDQDLYTG1_R2_P0 */
	0x000149a0,	/* DWC_DDRPHYA_DBYTE0_TXDQDLYTG1_R1_P0 */
	0x000169a0,	/* DWC_DDRPHYA_DBYTE1_TXDQDLYTG1_R1_P0 */
	0x000189a0,	/* DWC_DDRPHYA_DBYTE2_TXDQDLYTG1_R1_P0 */
	0x0001a9a0,	/* DWC_DDRPHYA_DBYTE3_TXDQDLYTG1_R1_P0 */
	0x0001499c,	/* DWC_DDRPHYA_DBYTE0_TXDQDLYTG1_R0_P0 */
	0x0001699c,	/* DWC_DDRPHYA_DBYTE1_TXDQDLYTG1_R0_P0 */
	0x0001899c,	/* DWC_DDRPHYA_DBYTE2_TXDQDLYTG1_R0_P0 */
	0x0001a99c,	/* DWC_DDRPHYA_DBYTE3_TXDQDLYTG1_R0_P0 */
	0x0001446c,	/* DWC_DDRPHYA_DBYTE0_DFIMRL_P0 */
	0x0001646c,	/* DWC_DDRPHYA_DBYTE1_DFIMRL_P0 */
	0x0001846c,	/* DWC_DDRPHYA_DBYTE2_DFIMRL_P0 */
	0x0001a46c,	/* DWC_DDRPHYA_DBYTE3_DFIMRL_P0 */
	0x000015e0,	/* DWC_DDRPHYA_MASTER0_HWTLPCSENA */
	0x000015e4,	/* DWC_DDRPHYA_MASTER0_HWTLPCSENB */
	0x00014850,	/* DWC_DDRPHYA_DBYTE0_PPTCTLSTATIC */
	0x00016850,	/* DWC_DDRPHYA_DBYTE1_PPTCTLSTATIC */
	0x00018850,	/* DWC_DDRPHYA_DBYTE2_PPTCTLSTATIC */
	0x0001a850,	/* DWC_DDRPHYA_DBYTE3_PPTCTLSTATIC */
	0x00001374,	/* DWC_DDRPHYA_MASTER0_PPTTRAINSETUP_P0 */
	0x00001388,	/* DWC_DDRPHYA_MASTER0_PPTTRAINSETUP2_P0 */
	0x00014860,	/* DWC_DDRPHYA_DBYTE0_PPTDQSCNTINVTRNTG0_P0 */
	0x00016860,	/* DWC_DDRPHYA_DBYTE1_PPTDQSCNTINVTRNTG0_P0 */
	0x00018860,	/* DWC_DDRPHYA_DBYTE2_PPTDQSCNTINVTRNTG0_P0 */
	0x0001a860,	/* DWC_DDRPHYA_DBYTE3_PPTDQSCNTINVTRNTG0_P0 */
	0x00014870,	/* DWC_DDRPHYA_DBYTE0_PPTDQSCNTINVTRNTG1_P0 */
	0x00016870,	/* DWC_DDRPHYA_DBYTE1_PPTDQSCNTINVTRNTG1_P0 */
	0x00018870,	/* DWC_DDRPHYA_DBYTE2_PPTDQSCNTINVTRNTG1_P0 */
	0x0001a870,	/* DWC_DDRPHYA_DBYTE3_PPTDQSCNTINVTRNTG1_P0 */
	0x0000140c,	/* DWC_DDRPHYA_MASTER0_HWTMRL_P0 */
	0x00001608,	/* DWC_DDRPHYA_MASTER0_DLLGAINCTL_P0 */
	0x00001618,	/* DWC_DDRPHYA_MASTER0_DLLLOCKPARAM_P0 */
	0x000003c8,	/* DWC_DDRPHYA_ACSM0_ACSMCTRL13 */
	0x00000308,	/* DWC_DDRPHYA_ACSM0_ACSMCTRL23 */
	0x00000c10,	/* DWC_DDRPHYA_INITENG0_SEQ0BGPR1_P0 */
	0x00000c28,	/* DWC_DDRPHYA_INITENG0_SEQ0BGPR2_P0 */
	0x00000c40,	/* DWC_DDRPHYA_INITENG0_SEQ0BGPR3_P0 */
	0x00000c58,	/* DWC_DDRPHYA_INITENG0_SEQ0BGPR4_P0 */
	0x00000c70,	/* DWC_DDRPHYA_INITENG0_SEQ0BGPR5_P0 */
	0x00000c88,	/* DWC_DDRPHYA_INITENG0_SEQ0BGPR6_P0 */
	0x00000ca0,	/* DWC_DDRPHYA_INITENG0_SEQ0BGPR7_P0 */
	0x00000cb8,	/* DWC_DDRPHYA_INITENG0_SEQ0BGPR8_P0 */
	0x000145fc,	/* DWC_DDRPHYA_DBYTE0_TRAININGINCDECDTSMEN_R0 */
	0x000165fc,	/* DWC_DDRPHYA_DBYTE1_TRAININGINCDECDTSMEN_R0 */
	0x000185fc,	/* DWC_DDRPHYA_DBYTE2_TRAININGINCDECDTSMEN_R0 */
	0x0001a5fc,	/* DWC_DDRPHYA_DBYTE3_TRAININGINCDECDTSMEN_R0 */
	0x00014600,	/* DWC_DDRPHYA_DBYTE0_TRAININGINCDECDTSMEN_R1 */
	0x00016600,	/* DWC_DDRPHYA_DBYTE1_TRAININGINCDECDTSMEN_R1 */
	0x00018600,	/* DWC_DDRPHYA_DBYTE2_TRAININGINCDECDTSMEN_R1 */
	0x0001a600,	/* DWC_DDRPHYA_DBYTE3_TRAININGINCDECDTSMEN_R1 */
	0x00014604,	/* DWC_DDRPHYA_DBYTE0_TRAININGINCDECDTSMEN_R2 */
	0x00016604,	/* DWC_DDRPHYA_DBYTE1_TRAININGINCDECDTSMEN_R2 */
	0x00018604,	/* DWC_DDRPHYA_DBYTE2_TRAININGINCDECDTSMEN_R2 */
	0x0001a604,	/* DWC_DDRPHYA_DBYTE3_TRAININGINCDECDTSMEN_R2 */
	0x00014608,	/* DWC_DDRPHYA_DBYTE0_TRAININGINCDECDTSMEN_R3 */
	0x00016608,	/* DWC_DDRPHYA_DBYTE1_TRAININGINCDECDTSMEN_R3 */
	0x00018608,	/* DWC_DDRPHYA_DBYTE2_TRAININGINCDECDTSMEN_R3 */
	0x0001a608,	/* DWC_DDRPHYA_DBYTE3_TRAININGINCDECDTSMEN_R3 */
	0x0001460c,	/* DWC_DDRPHYA_DBYTE0_TRAININGINCDECDTSMEN_R4 */
	0x0001660c,	/* DWC_DDRPHYA_DBYTE1_TRAININGINCDECDTSMEN_R4 */
	0x0001860c,	/* DWC_DDRPHYA_DBYTE2_TRAININGINCDECDTSMEN_R4 */
	0x0001a60c,	/* DWC_DDRPHYA_DBYTE3_TRAININGINCDECDTSMEN_R4 */
	0x00014610,	/* DWC_DDRPHYA_DBYTE0_TRAININGINCDECDTSMEN_R5 */
	0x00016610,	/* DWC_DDRPHYA_DBYTE1_TRAININGINCDECDTSMEN_R5 */
	0x00018610,	/* DWC_DDRPHYA_DBYTE2_TRAININGINCDECDTSMEN_R5 */
	0x0001a610,	/* DWC_DDRPHYA_DBYTE3_TRAININGINCDECDTSMEN_R5 */
	0x00014614,	/* DWC_DDRPHYA_DBYTE0_TRAININGINCDECDTSMEN_R6 */
	0x00016614,	/* DWC_DDRPHYA_DBYTE1_TRAININGINCDECDTSMEN_R6 */
	0x00018614,	/* DWC_DDRPHYA_DBYTE2_TRAININGINCDECDTSMEN_R6 */
	0x0001a614,	/* DWC_DDRPHYA_DBYTE3_TRAININGINCDECDTSMEN_R6 */
	0x00014618,	/* DWC_DDRPHYA_DBYTE0_TRAININGINCDECDTSMEN_R7 */
	0x00016618,	/* DWC_DDRPHYA_DBYTE1_TRAININGINCDECDTSMEN_R7 */
	0x00018618,	/* DWC_DDRPHYA_DBYTE2_TRAININGINCDECDTSMEN_R7 */
	0x0001a618,	/* DWC_DDRPHYA_DBYTE3_TRAININGINCDECDTSMEN_R7 */
	0x0001461c,	/* DWC_DDRPHYA_DBYTE0_TRAININGINCDECDTSMEN_R8 */
	0x0001661c,	/* DWC_DDRPHYA_DBYTE1_TRAININGINCDECDTSMEN_R8 */
	0x0001861c,	/* DWC_DDRPHYA_DBYTE2_TRAININGINCDECDTSMEN_R8 */
	0x0001a61c,	/* DWC_DDRPHYA_DBYTE3_TRAININGINCDECDTSMEN_R8 */
	0x000015f4,	/* DWC_DDRPHYA_MASTER0_HWTCAMODE */
	0x00014430,	/* DWC_DDRPHYA_DBYTE0_TSMBYTE0 */
	0x00016430,	/* DWC_DDRPHYA_DBYTE1_TSMBYTE0 */
	0x00018430,	/* DWC_DDRPHYA_DBYTE2_TSMBYTE0 */
	0x0001a430,	/* DWC_DDRPHYA_DBYTE3_TSMBYTE0 */
	/* 2D training */
	0x00014730,	/* DWC_DDRPHYA_DBYTE0_RXCLKDLYTG0_U0_P0 */
	0x00016730,	/* DWC_DDRPHYA_DBYTE1_RXCLKDLYTG0_U0_P0 */
	0x00018730,	/* DWC_DDRPHYA_DBYTE2_RXCLKDLYTG0_U0_P0 */
	0x0001a730,	/* DWC_DDRPHYA_DBYTE3_RXCLKDLYTG0_U0_P0 */
	0x00014734,	/* DWC_DDRPHYA_DBYTE0_RXCLKDLYTG0_U1_P0 */
	0x00016734,	/* DWC_DDRPHYA_DBYTE1_RXCLKDLYTG0_U1_P0 */
	0x00018734,	/* DWC_DDRPHYA_DBYTE2_RXCLKDLYTG0_U1_P0 */
	0x0001a734,	/* DWC_DDRPHYA_DBYTE3_RXCLKDLYTG0_U1_P0 */
	0x00014750,	/* DWC_DDRPHYA_DBYTE0_RXCLKDLYTG1_U0_P0 */
	0x00016750,	/* DWC_DDRPHYA_DBYTE1_RXCLKDLYTG1_U0_P0 */
	0x00018750,	/* DWC_DDRPHYA_DBYTE2_RXCLKDLYTG1_U0_P0 */
	0x0001a750,	/* DWC_DDRPHYA_DBYTE3_RXCLKDLYTG1_U0_P0 */
	0x00014754,	/* DWC_DDRPHYA_DBYTE0_RXCLKDLYTG1_U1_P0 */
	0x00016754,	/* DWC_DDRPHYA_DBYTE1_RXCLKDLYTG1_U1_P0 */
	0x00018754,	/* DWC_DDRPHYA_DBYTE2_RXCLKDLYTG1_U1_P0 */
	0x0001a754,	/* DWC_DDRPHYA_DBYTE3_RXCLKDLYTG1_U1_P0 */
	0x000144f8,	/* DWC_DDRPHYA_DBYTE0_VREFDAC0_R8 */
	0x000164f8,	/* DWC_DDRPHYA_DBYTE1_VREFDAC0_R8 */
	0x000184f8,	/* DWC_DDRPHYA_DBYTE2_VREFDAC0_R8 */
	0x0001a4f8,	/* DWC_DDRPHYA_DBYTE3_VREFDAC0_R8 */
	0x000144f4,	/* DWC_DDRPHYA_DBYTE0_VREFDAC0_R7 */
	0x000164f4,	/* DWC_DDRPHYA_DBYTE1_VREFDAC0_R7 */
	0x000184f4,	/* DWC_DDRPHYA_DBYTE2_VREFDAC0_R7 */
	0x0001a4f4,	/* DWC_DDRPHYA_DBYTE3_VREFDAC0_R7 */
	0x000144f0,	/* DWC_DDRPHYA_DBYTE0_VREFDAC0_R6 */
	0x000164f0,	/* DWC_DDRPHYA_DBYTE1_VREFDAC0_R6 */
	0x000184f0,	/* DWC_DDRPHYA_DBYTE2_VREFDAC0_R6 */
	0x0001a4f0,	/* DWC_DDRPHYA_DBYTE3_VREFDAC0_R6 */
	0x000144ec,	/* DWC_DDRPHYA_DBYTE0_VREFDAC0_R5 */
	0x000164ec,	/* DWC_DDRPHYA_DBYTE1_VREFDAC0_R5 */
	0x000184ec,	/* DWC_DDRPHYA_DBYTE2_VREFDAC0_R5 */
	0x0001a4ec,	/* DWC_DDRPHYA_DBYTE3_VREFDAC0_R5 */
	0x000144e8,	/* DWC_DDRPHYA_DBYTE0_VREFDAC0_R4 */
	0x000164e8,	/* DWC_DDRPHYA_DBYTE1_VREFDAC0_R4 */
	0x000184e8,	/* DWC_DDRPHYA_DBYTE2_VREFDAC0_R4 */
	0x0001a4e8,	/* DWC_DDRPHYA_DBYTE3_VREFDAC0_R4 */
	0x000144e4,	/* DWC_DDRPHYA_DBYTE0_VREFDAC0_R3 */
	0x000164e4,	/* DWC_DDRPHYA_DBYTE1_VREFDAC0_R3 */
	0x000184e4,	/* DWC_DDRPHYA_DBYTE2_VREFDAC0_R3 */
	0x0001a4e4,	/* DWC_DDRPHYA_DBYTE3_VREFDAC0_R3 */
	0x000144e0,	/* DWC_DDRPHYA_DBYTE0_VREFDAC0_R2 */
	0x000164e0,	/* DWC_DDRPHYA_DBYTE1_VREFDAC0_R2 */
	0x000184e0,	/* DWC_DDRPHYA_DBYTE2_VREFDAC0_R2 */
	0x0001a4e0,	/* DWC_DDRPHYA_DBYTE3_VREFDAC0_R2 */
	0x000144dc,	/* DWC_DDRPHYA_DBYTE0_VREFDAC0_R1 */
	0x000164dc,	/* DWC_DDRPHYA_DBYTE1_VREFDAC0_R1 */
	0x000184dc,	/* DWC_DDRPHYA_DBYTE2_VREFDAC0_R1 */
	0x0001a4dc,	/* DWC_DDRPHYA_DBYTE3_VREFDAC0_R1 */
	0x000144d8,	/* DWC_DDRPHYA_DBYTE0_VREFDAC0_R0 */
	0x000164d8,	/* DWC_DDRPHYA_DBYTE1_VREFDAC0_R0 */
	0x000184d8,	/* DWC_DDRPHYA_DBYTE2_VREFDAC0_R0 */
	0x0001a4d8,	/* DWC_DDRPHYA_DBYTE3_VREFDAC0_R0 */
};

_Static_assert(ARRAY_SIZE(csr_to_store) * sizeof(uint16_t) ==
	       BL31SSRAM_CSR_SIZE,
	       "Please sync BL31SSRAM_CSR_SIZE with csr_to_store length");

static void load_csr(uintptr_t load_from)
{
	int i;
	uint16_t csr;

	for (i = 0; i < ARRAY_SIZE(csr_to_store); i++) {
		csr = mmio_read_16(load_from);
		load_from += sizeof(uint16_t);
		mmio_write_16(DDRSS_BASE_ADDR + csr_to_store[i], csr);
	}
}

void store_csr(uintptr_t store_at)
{
	int i;
	uint16_t csr;

	mmio_write_16(MICROCONTMUXSEL, 0);
	mmio_write_16(UCCLKHCLKENABLES, HCLKEN_MASK | UCCLKEN_MASK);


	for (i = 0; i < ARRAY_SIZE(csr_to_store); i++) {
		csr = mmio_read_16(DDRSS_BASE_ADDR + csr_to_store[i]);
		mmio_write_16(store_at, csr);
		store_at += sizeof(uint16_t);
	}

	mmio_write_16(UCCLKHCLKENABLES, HCLKEN_MASK);
	mmio_write_16(MICROCONTMUXSEL, MICROCONTMUXSEL_MASK);
}

void ddrss_to_io_lp3_retention_mode(void)
{
	uint32_t sbrctl, pwrctl, swctl, dfimisc;

	/* Disable AXI Ports */
	mmio_write_16(DDRC_UMCTL2_MP_BASE_ADDR + OFFSET_DDRC_PCTRL_0, 0);
	mmio_write_16(DDRC_UMCTL2_MP_BASE_ADDR + OFFSET_DDRC_PCTRL_1, 0);
	mmio_write_16(DDRC_UMCTL2_MP_BASE_ADDR + OFFSET_DDRC_PCTRL_2, 0);

	while (mmio_read_32(DDRC_UMCTL2_MP_BASE_ADDR + OFFSET_DDRC_PSTAT))
		;

	/* Disable Scrubber */
	sbrctl = mmio_read_32(DDRC_BASE_ADDR + OFFSET_DDRC_SBRCTL);
	mmio_write_32(DDRC_BASE_ADDR + OFFSET_DDRC_SBRCTL,
		      sbrctl & (~SCRUB_EN_MASK));
	while (mmio_read_32(DDRC_BASE_ADDR + OFFSET_DDRC_SBRSTAT) &
		SCRUB_BUSY_MASK)
		;

	/* Move to Self Refresh */
	pwrctl = mmio_read_32(DDRC_BASE_ADDR + OFFSET_DDRC_PWRCTL);
	mmio_write_32(DDRC_BASE_ADDR + OFFSET_DDRC_PWRCTL,
		      pwrctl | SELFREF_SW_MASK);
	while ((mmio_read_32(DDRC_BASE_ADDR + OFFSET_DDRC_PSTAT) &
		OPERATING_MODE_MASK) != OPERATING_MODE_SELF_REFRESH)
		;
	while ((mmio_read_32(DDRC_BASE_ADDR + OFFSET_DDRC_PSTAT) &
		SELFREF_TYPE_MASK) != SELFREF_TYPE_NOT_UNDER_AUTO_SR_CTRL)
		;
	while ((mmio_read_32(DDRC_BASE_ADDR + OFFSET_DDRC_PSTAT) &
		SELFREF_STATE_MASK) != SELFREF_STATE_SRPD)
		;

	/* Transition Phy to LP3 */
	mmio_write_32(DDRC_BASE_ADDR + OFFSET_DDRC_DFIMISC, 0);
	swctl = mmio_read_32(DDRC_BASE_ADDR + OFFSET_DDRC_SWCTL);
	mmio_write_32(DDRC_BASE_ADDR + OFFSET_DDRC_SWCTL,
		      swctl & (~SW_DONE_MASK));
	dfimisc = mmio_read_32(DDRC_BASE_ADDR + OFFSET_DDRC_DFIMISC);
	mmio_write_32(DDRC_BASE_ADDR + OFFSET_DDRC_DFIMISC,
		      dfimisc | DFI_FREQUENCY(0x1f));
	dfimisc = mmio_read_32(DDRC_BASE_ADDR + OFFSET_DDRC_DFIMISC);
	mmio_write_32(DDRC_BASE_ADDR + OFFSET_DDRC_DFIMISC,
		      dfimisc | DFI_INIT_START_MASK);
	while (mmio_read_32(DDRC_BASE_ADDR + OFFSET_DDRC_DFISTAT) &
	       DFI_INIT_COMPLETE_MASK)
		;
	dfimisc = mmio_read_32(DDRC_BASE_ADDR + OFFSET_DDRC_DFIMISC);
	mmio_write_32(DDRC_BASE_ADDR + OFFSET_DDRC_DFIMISC,
		      dfimisc | DFI_FREQUENCY(0x1f));
	dfimisc = mmio_read_32(DDRC_BASE_ADDR + OFFSET_DDRC_DFIMISC);
	mmio_write_32(DDRC_BASE_ADDR + OFFSET_DDRC_DFIMISC,
		      dfimisc & (~DFI_INIT_START_MASK));
	while (!(mmio_read_32(DDRC_BASE_ADDR + OFFSET_DDRC_DFISTAT) &
		 DFI_INIT_COMPLETE_MASK))
		;

	swctl = mmio_read_32(DDRC_BASE_ADDR + OFFSET_DDRC_SWCTL);
	mmio_write_32(DDRC_BASE_ADDR + OFFSET_DDRC_SWCTL,
		      swctl | SW_DONE_MASK);
	while (!(mmio_read_32(DDRC_BASE_ADDR + OFFSET_DDRC_SWSTAT) &
		 SW_DONE_ACK_MASK))
		;

	/* Set PwrOkIn to 0 */
	mmio_write_32(DDR_RET_CONTROL,
		      mmio_read_32(DDR_RET_CONTROL) & (~DDR_RET_CONTROL_MASK));
	mmio_write_32(DDR_CONFIG_0,
		      mmio_read_32(DDR_CONFIG_0) | DDR_CONFIG_0_MEM_RET);
}

int ddrss_to_normal_mode(uintptr_t csr_array)
{
	int ret;
	uint32_t pwrctl, init0;

	ret = load_register_cfg(ddrc_cfg_size, ddrc_cfg);
	if (ret)
		return ret;

	ret = load_dq_cfg(dq_swap_cfg_size, dq_swap_cfg);
	if (ret)
		return ret;

	init0 = mmio_read_32(DDRC_BASE_ADDR + OFFSET_DDRC_INIT0);
	mmio_write_32(DDRC_BASE_ADDR + OFFSET_DDRC_INIT0,
		      init0 | SKIP_DRAM_INIT_MASK);
	pwrctl = mmio_read_32(DDRC_BASE_ADDR + OFFSET_DDRC_PWRCTL);
	mmio_write_32(DDRC_BASE_ADDR + OFFSET_DDRC_PWRCTL,
		      pwrctl | SELFREF_SW_MASK);

	/* Setup AXI ports parity */
	ret = set_axi_parity();
	if (ret != NO_ERR)
		return ret;

	mmio_write_32(MICROCONT_MUX_SEL, UNLOCK_CSR_ACCESS);
	ret = load_register_cfg(phy_cfg_size, phy_cfg);
	if (ret)
		return ret;
	mmio_write_32(MICROCONT_MUX_SEL, LOCK_CSR_ACCESS);

	/* Reload saved CSRs */
	mmio_write_32(MICROCONT_MUX_SEL, UNLOCK_CSR_ACCESS);
	load_csr(csr_array);
	mmio_write_32(MICROCONT_MUX_SEL, LOCK_CSR_ACCESS);

	mmio_write_32(MICROCONT_MUX_SEL, UNLOCK_CSR_ACCESS);
	ret = load_register_cfg(pie_cfg_size, pie_cfg);
	if (ret)
		return ret;
	mmio_write_32(MICROCONT_MUX_SEL, LOCK_CSR_ACCESS);

	return post_train_setup(false);
}

